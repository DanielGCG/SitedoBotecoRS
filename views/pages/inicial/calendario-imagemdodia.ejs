<main class="container py-4">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h2 class="mb-3">Calendário das Imagens do Dia</h2>
            <div id="calendario-loading" class="text-secondary">Carregando...</div>
        </div>
    </div>
    <div id="calendario-imagens"></div>
</main>

<style>
/* Calendário bonitinho */
.calendario-mes {
    margin-bottom: 2.5rem;
    background: #f8f9fa;
    border-radius: 12px;
    box-shadow: 0 2px 12px #eee;
    padding: 1.2rem 0.5rem 1.5rem 0.5rem;
}
.calendario-mes-titulo {
    font-size: 1.6rem;
    font-weight: bold;
    margin-bottom: 1.2rem;
    color: #2c3e50;
    letter-spacing: 0.04em;
    text-shadow: 0 1px 0 #fff, 0 2px 6px #ddd;
    text-align: center;
}
.calendario-grid {
    display: grid;
    grid-template-columns: repeat(7, minmax(40px, 1fr));
    gap: 0.5rem;
    width: 100%;
    margin-bottom: 1rem;
}
.calendario-grid-header {
    display: contents;
}
.calendario-grid-header-item {
    text-align: center;
    font-size: 1.05rem;
    color: #888;
    font-weight: 600;
    padding-bottom: 0.5rem;
}
.calendario-dia {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 8px #eee;
    padding: 0.5rem 0.2rem;
    text-align: center;
    transition: box-shadow 0.2s;
    position: relative;
    min-height: 120px;
}
.calendario-dia {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 8px #eee;
    border: 2px solid #bdbdbd;
    width: 130px;
    height: 130px;
    position: relative;
    margin: 0 auto;
    box-sizing: border-box;
    overflow: hidden;
}
.dia-conteudo {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    transition: box-shadow 0.2s, border-color 0.2s;
}
.calendario-dia:hover, .calendario-dia-quadro:hover {
    box-shadow: 0 4px 16px #ddd;
    background: #f8f9fa;
    border-color: #007bff;
}
.calendario-dia-numero {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: flex-start;
    justify-content: flex-end;
    font-size: 2.2rem;
    font-weight: 700;
    color: #e0e0e0;
    opacity: 0.45;
    z-index: 0;
    padding: 0.2em 0.3em;
    pointer-events: none;
}
.calendario-dia-vazio {
    background: #f8f9fa;
    border-radius: 10px;
    border: 2px dashed #e0e0e0;
    width: 130px;
    height: 130px;
    box-sizing: border-box;
    margin: 0 auto;
    position: relative;
    overflow: hidden;
}
.calendario-dia-vazio .calendario-dia-numero {
    color: #555;
    opacity: 0.6;
    font-size: 2rem;
}
.calendario-img {
    width: 96px;
    height: 96px;
    object-fit: cover;
    background: #f8f9fa;
    box-shadow: 0 1px 4px #ddd;
    position: absolute;
    left: 0;
    top: 0;
    z-index: 2;
    border-radius: 0;
}
.calendario-texto {
    color: #333;
    font-weight: 500;
    word-break: break-word;
    margin-top: auto;
    padding: 0.2rem;
    position: relative;
    z-index: 3;
    background-color: rgba(255,255,255,0.8);
    width: 100%;
}
.calendario-dia-vazio {
    background: none;
    box-shadow: none;
    min-height: 60px;
}

.calendario-dia-quadro {
    width: 130px;
    height: 130px;
    position: relative;
    margin: 0 auto;
    box-sizing: border-box;
    overflow: visible; /* Alterado de hidden para visible para permitir que a moldura ultrapasse os limites se necessário */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* Media queries para responsividade */
@media (max-width: 1200px) {
    .calendario-dia, .calendario-dia-vazio, .calendario-dia-quadro {
        width: 110px;
        height: 110px;
    }
    .calendario-dia-numero {
        font-size: 1.8rem;
    }
    .calendario-dia-vazio .calendario-dia-numero {
        font-size: 1.6rem;
    }
    .calendario-texto {
        font-size: 0.9rem;
    }
}

@media (max-width: 991px) {
    .calendario-grid {
        grid-template-columns: repeat(7, minmax(80px, 1fr));
    }
    .calendario-dia, .calendario-dia-vazio, .calendario-dia-quadro {
        width: 90px;
        height: 90px;
    }
    .calendario-dia-numero {
        font-size: 1.6rem;
    }
    .calendario-texto {
        font-size: 0.85rem;
    }

    /* Garante que o container e as imagens ocupem toda a célula em telas intermediárias */
    .calendario-dia-quadro .calendario-img-container,
    .calendario-dia-quadro img {
        position: absolute !important;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
        display: block;
    }
}

@media (max-width: 767px) {
    .calendario-grid {
        grid-template-columns: repeat(7, 1fr);
        gap: 0.25rem;
    }
    .calendario-dia, .calendario-dia-vazio, .calendario-dia-quadro {
        width: 100%;
        height: 0;
        padding-bottom: 100%; /* Faz com que a altura seja igual à largura */
        position: relative;
    }
    .calendario-dia > *, .calendario-dia-vazio > *, .calendario-dia-quadro > * {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    .calendario-dia-numero {
        font-size: 1.3rem;
    }
    .calendario-texto {
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .calendario-grid-header-item {
        font-size: 0.85rem;
    }

    /* Garante que o container e as imagens ocupem toda a célula em telas intermediárias pequenas */
    .calendario-dia-quadro .calendario-img-container,
    .calendario-dia-quadro img {
        position: absolute !important;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
        display: block;
    }
}

@media (max-width: 576px) {
    .calendario-dia, .calendario-dia-vazio, .calendario-dia-quadro {
        width: 100%;
        height: 0;
        padding-bottom: 100%; /* mantém quadrado */
        position: relative;
    }

    /* Garante que o container e as imagens ocupem toda a célula */
    .calendario-dia-quadro .calendario-img-container,
    .calendario-dia-quadro img {
        position: absolute !important;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
        display: block;
    }

    /* O número do dia pode ser absoluto */
    .calendario-dia-numero {
        position: absolute;
        top: 0;
        right: 0;
        font-size: 1.3rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    const container = document.getElementById('calendario-imagens');
    const loading = document.getElementById('calendario-loading');
    try {
        const res = await fetch('/API/imagemdodia/ativas');
        if (!res.ok) throw new Error();
        const imagens = await res.json();
        if (!imagens.length) {
            loading.textContent = 'Nenhuma imagem encontrada.';
            return;
        }
        loading.style.display = 'none';
        // Agrupa por mês
        const grupos = {};
        imagens.forEach(img => {
            const d = new Date(img.start_at);
            const mes = d.toLocaleString('default', { month: 'long' });
            const ano = d.getFullYear();
            const chave = `${mes} ${ano}`;
            if (!grupos[chave]) grupos[chave] = [];
            grupos[chave].push({
                url: img.url,
                border_url: img.border_url,
                texto: img.texto,
                dia: d.getDate(),
                mes: d.getMonth(),
                ano: d.getFullYear(),
                data: d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' })
            });
        });
        // Renderiza meses como calendário real
        container.innerHTML = Object.entries(grupos).map(([mesNome, lista]) => {
            const ano = lista[0].ano;
            const mes = lista[0].mes;
            const diasNoMes = new Date(ano, mes + 1, 0).getDate();
            const primeiroDiaSemana = new Date(ano, mes, 1).getDay();
            const dias = Array(diasNoMes).fill(null);
            lista.forEach(item => {
                dias[item.dia - 1] = item;
            });
            let html = `<div class="calendario-mes">
                <div class="calendario-mes-titulo">${mesNome}</div>
                <div class="calendario-grid">
                    <div class="calendario-grid-header calendario-grid">
                        <div class="calendario-grid-header-item">Dom</div>
                        <div class="calendario-grid-header-item">Seg</div>
                        <div class="calendario-grid-header-item">Ter</div>
                        <div class="calendario-grid-header-item">Qua</div>
                        <div class="calendario-grid-header-item">Qui</div>
                        <div class="calendario-grid-header-item">Sex</div>
                        <div class="calendario-grid-header-item">Sáb</div>
                    </div>`;
            // Renderiza as caixinhas do calendário (incluindo vazias antes e depois)
            let diaAtual = 1;
            const totalCelulas = Math.ceil((primeiroDiaSemana + diasNoMes) / 7) * 7;
            for (let i = 0; i < totalCelulas; i++) {
                if (i < primeiroDiaSemana || diaAtual > diasNoMes) {
                    // Caixinha vazia
                    html += `<div class="calendario-dia-vazio">${i >= primeiroDiaSemana && diaAtual <= diasNoMes ? `<span class='calendario-dia-numero'>${diaAtual}</span>` : ''}</div>`;
                    if (i >= primeiroDiaSemana && diaAtual <= diasNoMes) diaAtual++;
                } else {
                    const item = dias[diaAtual - 1];
                    if (item && item.url && item.url.trim()) {
                        // Tem imagem: mostra o quadrado sem borda arredondada, permitindo que o quadro tenha sua própria borda
                        html += `<div class="calendario-dia-quadro">
                            <span class="calendario-dia-numero">${diaAtual}</span>
                            <div class="calendario-img-container" style="width:100%;height:100%;position:relative;">
                                <img src="${item.url}" alt="${item.texto || ''}" style="width:100%;height:100%;object-fit:cover;position:absolute;left:0;top:0;background:#f8f9fa;z-index:1;">
                                ${item.border_url ? `<img src="${item.border_url}" alt="Moldura" style="width:100%;height:100%;position:absolute;left:0;top:0;z-index:2;pointer-events:none;">` : ''}
                            </div>
                        </div>`;
                    } else {
                        // Não tem imagem: mostra apenas o número do dia
                        html += `<div class="calendario-dia-vazio">
                            <div class="dia-conteudo">
                                <span class="calendario-dia-numero">${diaAtual}</span>
                            </div>
                        </div>`;
                    }
                    diaAtual++;
                }
            }
            html += `</div></div>`;
            return html;
        }).join('');
    } catch {
        loading.textContent = 'Erro ao carregar imagens.';
    }
});
</script>
