<main class="container py-4">
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h2 class="mb-3">Calendário das Imagens do Dia</h2>
      <div id="calendario-loading" class="text-secondary">Carregando...</div>
    </div>
  </div>
  <div id="calendario-imagens"></div>
</main>

<style>
/* Só complementos mínimos */
.calendario-mes {
  margin-bottom: 2rem;
}
.calendario-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: .5rem;
}
.calendario-dia, .calendario-dia-vazio {
  aspect-ratio: 1/1;
  position: relative;
}
.calendario-dia-numero {
  position: absolute;
  top: .25rem;
  right: .4rem;
  font-size: 1.2rem;
  font-weight: bold;
  color: rgba(0,0,0,.25);
}
.calendario-dia img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 0;
}
.calendario-img-container img:last-child {
  z-index: 2;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', async function() {
  const container = document.getElementById('calendario-imagens');
  const loading = document.getElementById('calendario-loading');
  try {
    const res = await fetch('/API/imagemdodia/ativas');
    if (!res.ok) throw new Error();
    const imagens = await res.json();
    if (!imagens.length) {
      loading.textContent = 'Nenhuma imagem encontrada.';
      return;
    }
    loading.style.display = 'none';

    const grupos = {};
    imagens.forEach(img => {
      const d = new Date(img.start_at);
      const mes = d.toLocaleString('default', { month: 'long' });
      const ano = d.getFullYear();
      const chave = `${mes} ${ano}`;
      if (!grupos[chave]) grupos[chave] = [];
      grupos[chave].push({
        url: img.url,
        border_url: img.border_url,
        texto: img.texto,
        dia: d.getDate(),
        mes: d.getMonth(),
        ano: ano
      });
    });

    container.innerHTML = Object.entries(grupos).map(([mesNome, lista]) => {
      const ano = lista[0].ano;
      const mes = lista[0].mes;
      const diasNoMes = new Date(ano, mes + 1, 0).getDate();
      const primeiroDiaSemana = new Date(ano, mes, 1).getDay();
      const dias = Array(diasNoMes).fill(null);
      lista.forEach(item => dias[item.dia - 1] = item);

      let html = `
        <div class="card shadow-sm calendario-mes">
          <div class="card-header text-center fw-bold fs-5">${mesNome}</div>
          <div class="card-body p-2">
            <div class="calendario-grid text-center">
              <div class="fw-semibold text-secondary">Dom</div>
              <div class="fw-semibold text-secondary">Seg</div>
              <div class="fw-semibold text-secondary">Ter</div>
              <div class="fw-semibold text-secondary">Qua</div>
              <div class="fw-semibold text-secondary">Qui</div>
              <div class="fw-semibold text-secondary">Sex</div>
              <div class="fw-semibold text-secondary">Sáb</div>
      `;

      let diaAtual = 1;
      const totalCelulas = Math.ceil((primeiroDiaSemana + diasNoMes) / 7) * 7;
      for (let i = 0; i < totalCelulas; i++) {
        if (i < primeiroDiaSemana || diaAtual > diasNoMes) {
          html += `<div class="calendario-dia-vazio border border-0"></div>`;
        } else {
          const item = dias[diaAtual - 1];
          if (item && item.url) {
            html += `
              <div class="calendario-dia position-relative p-0" style="background:none;border:none;box-shadow:none;">
                <span class="calendario-dia-numero">${diaAtual}</span>
                <div class="calendario-img-container position-relative w-100 h-100" style="width:100%;height:100%;">
                  <img src="${item.url}" alt="${item.texto || ''}" style="width:100%;height:100%;object-fit:cover;position:absolute;left:0;top:0;">
                  ${item.border_url ? `<img src="${item.border_url}" style="width:100%;height:100%;position:absolute;left:0;top:0;pointer-events:none;">` : ''}
                </div>
              </div>`;
          } else {
            html += `
              <div class="calendario-dia-vazio border rounded bg-light">
                <span class="calendario-dia-numero">${diaAtual}</span>
              </div>`;
          }
          diaAtual++;
        }
      }

      html += `</div></div></div>`;
      return html;
    }).join('');
  } catch {
    loading.textContent = 'Erro ao carregar imagens.';
  }
});
</script>
